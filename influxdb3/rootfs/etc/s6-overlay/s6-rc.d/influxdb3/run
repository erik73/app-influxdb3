#!/command/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Home Assistant Add-on: InfluxDB3
# Runs the InfluxDB3 Server
# ==============================================================================
export INFLUXDB3_ENTERPRISE_LICENSE_EMAIL=$(bashio::config 'license_email')
export INFLUXDB3_ENTERPRISE_LICENSE_TYPE=home
# export INFLUXDB3_ENTERPRISE_CLUSTER_ID=cluster0
# export INFLUXDB3_NODE_IDENTIFIER_PREFIX=$(bashio::addon.hostname)
# export INFLUXDB3_OBJECT_STORE=file
#export INFLUXDB3_DB_DIR=/data/influxdb3
export INFLUXDB3_LOG_FILTER=$(bashio::config 'influxd_log_level')

for envvar in $(bashio::config 'envvars|keys'); do
    name=$(bashio::config "envvars[${envvar}].name")
    value=$(bashio::config "envvars[${envvar}].value")
    bashio::log.debug "Setting Env Variable ${name} to ${value}"
    export "${name}=${value}"
done

bashio::log.info 'Starting InfluxDB v3.x...'

# Run InfluxDB
exec influxdb3 serve \
    --node-id node0 \
    --cluster-id cluster0 \
    --object-store file \
    --data-dir /data/influxdb3 \
    --plugin-dir /data/influx-plugins \
    --exec-mem-pool-bytes 30% \
    --force-snapshot-mem-threshold 70% \
    --wal-snapshot-size 100 \
    --parquet-mem-cache-size 10%
